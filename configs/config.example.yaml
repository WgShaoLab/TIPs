# tips-pipeline config (with TE search via blastp-short)

sample:
  # Path to the working directory for ONE biological sample.
  # Assumed subdirs:
  #   {sample_path}/mgf  (for de novo tools, *.mgf)
  #   {sample_path}/mzML (for DB search, *.mzML)
  path: "/path/to/sample_dir"

  # Name of the sample (used for logging / outputs)
  name: "Sample_XYZ"

gpu:
  # Which GPU ID to expose to de novo tools (CUDA_VISIBLE_DEVICES)
  id: "0"

denovo:
  # Minimum per-AA score to consider amino acid confident
  min_score: 0.75
  # Minimum peptide/tag length to keep
  min_length: 8

  # Paths to models/binaries of de novo engines
  casanovo:
    enable: true
    binary: "/opt/casanovo/bin/casanovo"
    model_ckpt: "/opt/casanovo/models/casanovo_v4_2_0.ckpt"
    config_yaml: "/opt/casanovo/configs/casanovo.yaml"

  pepnet:
    enable: true
    python_bin: "/opt/miniconda/envs/pepnet/bin/python"
    script: "/opt/PepNet/denovo.py"
    model_h5: "/opt/PepNet/model.h5"

  instanovo:
    enable: true
    python_bin: "/opt/miniconda/envs/instanovo/bin/python"
    module_call: "instanovo.transformer.predict"
    model_ckpt: "/opt/InstaNovo/instanovo_extended.ckpt"
    # If InstaNovo needs PYTHONPATH or CUDA vars, define here:
    extra_env:
      PYTHONPATH: "/opt/InstaNovo/InstaNovo"
      CUDA_VISIBLE_DEVICES: "0"

database_build:
  # Reference FASTA ingredients
  human_fasta: "/ref/fasta/UP000005640_9606_processed_tag_0.fasta"
  contaminants_fasta: "/ref/fasta/Contaminants_tag_0.fasta"

  # TE-derived peptide FASTA produced by de novo stage (header=seq)
  # 默认由 stage_denovo 自动写到 {sample_path}/Denovo/Denovo_TE_SoftMerged_InstaNovo.fasta
  denovo_te_tagged_fasta: "AUTO"

  # === 新增：用于“tag→TE 大库(blast)”的 TE 数据库与选择策略 ===
  # 大而全的 TE 蛋白/翻译库（单行 FASTA；header 的 id 必须能与 blast saccver 对上）
  te_db_fasta: "/ref/fasta/hg38_rmsk_6_frame_singleLine_done.fasta"

  # 选择策略：若 method=blast，则在构库前先把 de novo tag 用 blastp-short 去搜 TE 大库，
  # 抽取命中的 TE 条目形成“样本级 TE 子库”；否则直接使用 de novo 合并 FASTA 作为 TE 候选。
  te_selection:
    method: "blast"         # "blast" | "direct"
    chunks: 15              # 查询 FASTA 的并行拆分份数
    threads_per_chunk: 4    # 每份子任务的线程

  # Where to write combined search DB (w/decoys)
  # Path will end up like: {sample_path}/DB_search_iProphet/<ENGINE>/<ENGINE>_DBsearch.fasta
  add_decoy: true  # reverse-sequence decoy

# === 新增：TE 子库选择用的 blastp-short 可执行文件（与 postprocessing 分开）===
blast:
  blastp_bin: "/opt/blastp/blastp"

search_engines:
  comet:
    enable: true
    binary: "/opt/tpp/bin/comet"
    params_file: "/configs/comet_iprophet.params"

  msfragger:
    enable: true
    java_bin: "/usr/bin/java"
    jar: "/opt/MSFragger/MSFragger-4.1.jar"
    base_params: "/configs/closed_fragger.params"

  msgfplus:
    enable: true
    java_bin: "/usr/bin/java"
    jar: "/opt/MS-GF+/MSGFPlus.jar"
    params_file: "/configs/MSGFPlus_Params_iprophet.txt"
    parallel_tasks: 10        # processes for MSGF+

postprocessing:
  # Trans-posable element vs canonical split
  # We tag TE-derived entries with PE=1 and canonical (human proteome) with PE=0
  fdr_threshold: 0.03

  tpp:
    xinteract: "/opt/tpp/bin/xinteract"
    refreshparser: "/opt/tpp/bin/RefreshParser"
    pepxml2csv: "/opt/tpp/bin/pepxml2csv.py"

  philosopher:
    binary: "/opt/philosopher/philosopher"

  # 保留原先“去同源用的 blastp”配置（与 TE 选择用的 blastp 可不同）
  blastp:
    enable: true
    binary: "/opt/blastp/blastp"   # blastp-short-capable binary
    threads_per_job: 4
    human_proteome_blastdb: "/ref/blastdb/human_UP000005640"

hla_binding:
  enable: true
  mixmhcpred_bin: "/opt/MixMHCpred/MixMHCpred"
  hla_alleles: "A0201,A6801,B1302,B4001,C0304,C0602"
  peptide_length_min: 8
  peptide_length_max: 14
