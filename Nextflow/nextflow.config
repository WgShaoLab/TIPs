nextflow.enable.dsl=2

params {
  help   = false
  outdir = "output"

  // Input
  sample_dir = null

  // Reference databases and files
  te_blastdb_dir   = "/path/to/TIPs/resources/te/blastdb"  
  te_npy           = "/path/to/TIPs/resources/te/hg38_rmsk_6_frame_singleLine_done.npy"
  te_class_dic     = "/path/to/TIPs/resources/te/TE_class_dic.npy"
  uniprot_fasta    = "/path/to/TIPs/resources/db/UP000005640_9606_processed.fasta"
  contaminants_fasta = "/path/to/TIPs/resources/db/Contaminants.fasta"
  blastp_db        = "/path/to/TIPs/resources/db/human_blastpdb"

  // Search engine configs
  comet_params     = "/path/to/TIPs/resources/search_params/comet.params"
  msfragger_params = "/path/to/TIPs/resources/search_params/msfragger.params"
  msgf_params      = "/path/to/TIPs/resources/search_params/msgfplus.params"

  // Host code base mounted by container options 
  code_base = "/path/to/TIPs/Nextflow/code"

  // Host de novo runner script
  denovo_runner = "/path/to/TIPs/Nextflow/code/run_denovo_tool_batch_final.py"

  // De novo parameters
  aa_score_threshold = 0.75
  min_peptide_length = 8
  blastp_workers     = 8

  // FDR control
  fdr_threshold = 0.03

  // MHC binding prediction
  mhc_alleles = "A0201,B4402,C0501"

  // Resources
  threads       = 16
  msgf_parallel = 15

  // Containers 
  container_tips_core   = "tips-core:0.2"
  container_dbsearch    = "tips-core:0.2"   
}

profiles {
  docker {
    docker.enabled = true
  }
}

docker {
  enabled = true
  // Apply the same user mapping you used in docker run
  runOptions = "-u \$(id -u):\$(id -g) -v ${params.code_base}:${params.code_base} "
}

process {
  executor = 'local'
  // Default
  errorStrategy = 'terminate'
  maxRetries = 0

  // --- Containers ---
  withName: RAW_TO_MZML { container = params.container_tips_core }
  withName: RAW_TO_MGF  { container = params.container_tips_core }

  // de novo batch runs on host (it internally launches docker itself)
  withName: DENOVO_ALL_BATCH { container = null }

  // Most downstream tools are assumed in one image (adjust if you split later)
  withName: PROCESS_DENOVO_RESULTS      { container = params.container_dbsearch }
  withName: BLASTP_DENOVO_PEPTIDES      { container = params.container_dbsearch }
  withName: BUILD_DENOVO_DATABASE       { container = params.container_dbsearch }
  withName: BUILD_SEARCH_DATABASE       { container = params.container_dbsearch }
  withName: COMET_SEARCH                { container = params.container_dbsearch }
  withName: MSFRAGGER_SEARCH            { container = params.container_dbsearch }
  withName: MSGF_SEARCH                 { container = params.container_dbsearch }
  withName: MSGF_CONVERT                { container = params.container_dbsearch }
  withName: SEPARATE_TE_CANONICAL       { container = params.container_dbsearch }
  withName: PEPTIDE_PROPHET_TE          { container = params.container_dbsearch }
  withName: PEPTIDE_PROPHET_CN          { container = params.container_dbsearch }
  withName: FDR_FILTER_TE               { container = params.container_dbsearch }
  withName: FDR_FILTER_CN               { container = params.container_dbsearch }
  withName: IPROPHET_INTEGRATION_TE     { container = params.container_dbsearch }
  withName: IPROPHET_INTEGRATION_CN     { container = params.container_dbsearch }
  withName: BLASTP_CANONICAL_FILTER     { container = params.container_dbsearch }
  withName: MHC_BINDING_PREDICTION      { container = params.container_dbsearch }

  // --- Resources ---
  withName: PEPTIDE_PROPHET_TE { cpus = params.threads }
  withName: PEPTIDE_PROPHET_CN { cpus = params.threads }
  withName: IPROPHET_INTEGRATION_TE { cpus = params.threads }
  withName: IPROPHET_INTEGRATION_CN { cpus = params.threads }

  // --- publishDir policy (key nodes only; all go under params.outdir) ---
  withName: RAW_TO_MZML {
    publishDir = [ path: "${params.outdir}/mzML", mode: 'copy', overwrite: true ]
  }
  withName: RAW_TO_MGF {
    publishDir = [ path: "${params.outdir}/mgf", mode: 'copy', overwrite: true ]
  }

  withName: DENOVO_ALL_BATCH {
    publishDir = [ path: "${params.outdir}/denovo", mode: 'copy', overwrite: true ]
  }
  withName: PROCESS_DENOVO_RESULTS {
    publishDir = [ path: "${params.outdir}/denovo", mode: 'copy', overwrite: true ]
  }

  withName: BUILD_DENOVO_DATABASE {
    publishDir = [ path: "${params.outdir}/denovo_db", mode: 'copy', overwrite: true ]
  }
  withName: BUILD_SEARCH_DATABASE {
    publishDir = [ path: "${params.outdir}/search_db", mode: 'copy', overwrite: true ]
  }

  withName: COMET_SEARCH       { publishDir = [ path: "${params.outdir}/dbsearch/Comet",      mode: 'copy', overwrite: true ] }
  withName: MSFRAGGER_SEARCH   { publishDir = [ path: "${params.outdir}/dbsearch/MSfragger",  mode: 'copy', overwrite: true ] }
  withName: MSGF_SEARCH        { publishDir = [ path: "${params.outdir}/dbsearch/MS_GF",      mode: 'copy', overwrite: true ] }
  withName: MSGF_CONVERT       { publishDir = [ path: "${params.outdir}/dbsearch/MS_GF",      mode: 'copy', overwrite: true ] }

  withName: SEPARATE_TE_CANONICAL { publishDir = [ path: "${params.outdir}/dbsearch/separated", mode: 'copy', overwrite: true ] }

  withName: PEPTIDE_PROPHET_TE { publishDir = [ path: "${params.outdir}/dbsearch/peptideprophet/TE", mode: 'copy', overwrite: true ] }
  withName: PEPTIDE_PROPHET_CN { publishDir = [ path: "${params.outdir}/dbsearch/peptideprophet/CN", mode: 'copy', overwrite: true ] }

  withName: FDR_FILTER_TE      { publishDir = [ path: "${params.outdir}/dbsearch/fdr/TE", mode: 'copy', overwrite: true ] }
  withName: FDR_FILTER_CN      { publishDir = [ path: "${params.outdir}/dbsearch/fdr/CN", mode: 'copy', overwrite: true ] }

  withName: IPROPHET_INTEGRATION_TE { publishDir = [ path: "${params.outdir}/dbsearch/iprophet/TE", mode: 'copy', overwrite: true ] }
  withName: IPROPHET_INTEGRATION_CN { publishDir = [ path: "${params.outdir}/dbsearch/iprophet/CN", mode: 'copy', overwrite: true ] }

  withName: BLASTP_CANONICAL_FILTER { publishDir = [ path: "${params.outdir}/post/te_blastp_filter", mode: 'copy', overwrite: true ] }
  withName: MHC_BINDING_PREDICTION  { publishDir = [ path: "${params.outdir}/integrate", mode: 'copy', overwrite: true ] }
}